<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.wellkorea.backend.delivery.infrastructure.mapper.DeliveryMapper">

    <!-- DeliveryLineItemView result map for record -->
    <resultMap id="DeliveryLineItemViewResult" type="com.wellkorea.backend.delivery.api.dto.query.DeliveryLineItemView">
        <constructor>
            <arg column="id" javaType="Long"/>
            <arg column="product_id" javaType="Long"/>
            <arg column="product_name" javaType="String"/>
            <arg column="product_sku" javaType="String"/>
            <arg column="quantity_delivered" javaType="java.math.BigDecimal"/>
        </constructor>
    </resultMap>

    <!-- DeliveryDetailView result map with nested select for line items -->
    <resultMap id="DeliveryDetailViewResult" type="com.wellkorea.backend.delivery.api.dto.query.DeliveryDetailView">
        <constructor>
            <idArg column="id" javaType="Long"/>
            <arg column="project_id" javaType="Long"/>
            <arg column="quotation_id" javaType="Long"/>
            <arg column="job_code" javaType="String"/>
            <arg column="delivery_date" javaType="java.time.LocalDate"/>
            <arg column="status" javaType="String"/>
            <arg column="delivered_by_id" javaType="Long"/>
            <arg column="delivered_by_name" javaType="String"/>
            <arg column="notes" javaType="String"/>
            <arg column="created_at" javaType="String"/>
            <arg column="updated_at" javaType="String"/>
            <arg column="id" javaType="java.util.List" select="findLineItemsByDeliveryId"/>
        </constructor>
    </resultMap>

    <!-- Main query: Find delivery detail by ID -->
    <select id="findDetailById" resultMap="DeliveryDetailViewResult">
        SELECT
            d.id,
            d.project_id,
            d.quotation_id,
            p.job_code,
            d.delivery_date,
            d.status,
            d.delivered_by_id,
            u.full_name AS delivered_by_name,
            d.notes,
            TO_CHAR(d.created_at AT TIME ZONE 'UTC', 'YYYY-MM-DD"T"HH24:MI:SS"Z"') AS created_at,
            TO_CHAR(d.updated_at AT TIME ZONE 'UTC', 'YYYY-MM-DD"T"HH24:MI:SS"Z"') AS updated_at
        FROM deliveries d
        INNER JOIN projects p ON d.project_id = p.id
        INNER JOIN users u ON d.delivered_by_id = u.id
        WHERE d.id = #{id}
    </select>

    <!-- Nested select: Find line items for a delivery -->
    <select id="findLineItemsByDeliveryId" resultMap="DeliveryLineItemViewResult">
        SELECT
            li.id,
            li.product_id,
            prod.name AS product_name,
            prod.sku AS product_sku,
            li.quantity_delivered
        FROM delivery_line_items li
        INNER JOIN products prod ON li.product_id = prod.id
        WHERE li.delivery_id = #{deliveryId}
        ORDER BY li.id
    </select>

    <!-- DeliverySummaryView result map with nested select for line items -->
    <resultMap id="DeliverySummaryViewResult" type="com.wellkorea.backend.delivery.api.dto.query.DeliverySummaryView">
        <constructor>
            <idArg column="id" javaType="Long"/>
            <arg column="project_id" javaType="Long"/>
            <arg column="quotation_id" javaType="Long"/>
            <arg column="delivery_date" javaType="java.time.LocalDate"/>
            <arg column="status" javaType="String"/>
            <arg column="delivered_by_name" javaType="String"/>
            <arg column="line_item_count" javaType="Integer"/>
            <arg column="total_quantity_delivered" javaType="java.math.BigDecimal"/>
            <arg column="created_at" javaType="String"/>
            <arg column="id" javaType="java.util.List" select="findLineItemsByDeliveryId"/>
        </constructor>
    </resultMap>

    <!-- Find deliveries with optional project and status filters -->
    <select id="findWithFilters" resultMap="DeliverySummaryViewResult">
        SELECT
            d.id,
            d.project_id,
            d.quotation_id,
            d.delivery_date,
            d.status,
            u.full_name AS delivered_by_name,
            (SELECT COUNT(*) FROM delivery_line_items li WHERE li.delivery_id = d.id) AS line_item_count,
            (SELECT COALESCE(SUM(li.quantity_delivered), 0) FROM delivery_line_items li WHERE li.delivery_id = d.id) AS total_quantity_delivered,
            TO_CHAR(d.created_at AT TIME ZONE 'UTC', 'YYYY-MM-DD"T"HH24:MI:SS"Z"') AS created_at
        FROM deliveries d
        INNER JOIN users u ON d.delivered_by_id = u.id
        <where>
            <if test="projectId != null">
                d.project_id = #{projectId}
            </if>
            <if test="status != null">
                AND d.status = #{status}
            </if>
        </where>
        ORDER BY d.delivery_date DESC, d.created_at DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- Count for pagination with optional filters -->
    <select id="countWithFilters" resultType="long">
        SELECT COUNT(*)
        FROM deliveries d
        <where>
            <if test="projectId != null">
                d.project_id = #{projectId}
            </if>
            <if test="status != null">
                AND d.status = #{status}
            </if>
        </where>
    </select>

</mapper>
