<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.wellkorea.backend.production.infrastructure.mapper.TaskFlowMapper">

    <!-- TaskNodeView result map for record -->
    <resultMap id="TaskNodeViewResult" type="com.wellkorea.backend.production.api.dto.query.TaskNodeView">
        <constructor>
            <arg column="node_id" javaType="String"/>
            <arg column="title" javaType="String"/>
            <arg column="assignee" javaType="String"/>
            <arg column="deadline" javaType="java.time.LocalDate"/>
            <arg column="progress" javaType="Integer"/>
            <arg column="position_x" javaType="Double"/>
            <arg column="position_y" javaType="Double"/>
        </constructor>
    </resultMap>

    <!-- TaskEdgeView result map for record -->
    <resultMap id="TaskEdgeViewResult" type="com.wellkorea.backend.production.api.dto.query.TaskEdgeView">
        <constructor>
            <arg column="edge_id" javaType="String"/>
            <arg column="source_node_id" javaType="String"/>
            <arg column="target_node_id" javaType="String"/>
        </constructor>
    </resultMap>

    <!-- TaskFlowView result map with nested selects for nodes and edges -->
    <resultMap id="TaskFlowViewResult" type="com.wellkorea.backend.production.api.dto.query.TaskFlowView">
        <constructor>
            <idArg column="id" javaType="Long"/>
            <arg column="project_id" javaType="Long"/>
            <arg column="id" javaType="java.util.List" select="findNodesByFlowId"/>
            <arg column="id" javaType="java.util.List" select="findEdgesByFlowId"/>
            <arg column="created_at" javaType="java.time.Instant"/>
            <arg column="updated_at" javaType="java.time.Instant"/>
        </constructor>
    </resultMap>

    <!-- Find task flow by project ID -->
    <select id="findByProjectId" resultMap="TaskFlowViewResult">
        SELECT tf.id,
               tf.project_id,
               tf.created_at,
               tf.updated_at
        FROM task_flows tf
        WHERE tf.project_id = #{projectId}
    </select>

    <!-- Find task flow by ID -->
    <select id="findById" resultMap="TaskFlowViewResult">
        SELECT tf.id,
               tf.project_id,
               tf.created_at,
               tf.updated_at
        FROM task_flows tf
        WHERE tf.id = #{id}
    </select>

    <!-- Nested select: Find all nodes for a task flow -->
    <select id="findNodesByFlowId" resultMap="TaskNodeViewResult">
        SELECT tn.node_id,
               tn.title,
               tn.assignee,
               tn.deadline,
               tn.progress,
               tn.position_x,
               tn.position_y
        FROM task_nodes tn
        WHERE tn.flow_id = #{flowId}
        ORDER BY tn.node_id
    </select>

    <!-- Nested select: Find all edges for a task flow -->
    <select id="findEdgesByFlowId" resultMap="TaskEdgeViewResult">
        SELECT te.edge_id,
               te.source_node_id,
               te.target_node_id
        FROM task_edges te
        WHERE te.flow_id = #{flowId}
        ORDER BY te.edge_id
    </select>

</mapper>
